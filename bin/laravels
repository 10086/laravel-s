#!/usr/bin/env php
<?php
$basePath = realpath(__DIR__ . '/../');
include $basePath . '/vendor/autoload.php';

$lvs = new GoLaravelS($basePath);

$action = isset($argv[1]) ? $argv[1] : null;
switch ($action) {
    case 'start':
        //--d|daemonize : Whether run as a daemon for start & restart} {--i|ignore : Whether ignore checking process pid for start & restart
        $lvs->start();
        break;
    case 'stop':
        $lvs->stop();
        break;
    case 'restart':
        $lvs->restart();
        break;
    case 'reload':
        $lvs->reload();
        break;
    default:
        outputLog('Usage: php ssr.php start|stop|restart|reload');
        break;
}

class GoLaravelS
{
    protected $basePath;
    protected $config = [];

    public function __construct($basePath)
    {
        $this->basePath = $basePath;

        // Initialize configuration config/laravels.json
        $this->runArtisanCommand('laravels config');
    }

    public function artisanCmd($subCmd = null)
    {
        $phpCmd = sprintf('%s -c "%s"', PHP_BINARY, php_ini_loaded_file());
        $artisanCmd = sprintf('%s %s/artisan', $phpCmd, $this->basePath);
        if ($subCmd !== null) {
            $artisanCmd .= ' ' . $subCmd;
        }
        return $artisanCmd;
    }

    public function runArtisanCommand($cmd)
    {
        $cmd = $this->artisanCmd($cmd);
        self::runCommand($cmd);
    }

    public function getConfig()
    {
        if (empty($this->config)) {
            $json = file_get_contents($this->basePath . '/config/laravels.json');
            $this->config = (array)json_decode($json, true);
        }
        return $this->config;
    }

    public function start()
    {
        // Show info
        $this->runArtisanCommand('laravels info');

        // Here we go...
        $config = $this->getConfig();
        (new Hhxsv5\LaravelS\LaravelS($config['svrConf'], $config['laravelConf']))->run();
    }

    public function stop()
    {
        $config = $this->getConfig();
        $pidFile = $config['svrConf']['swoole']['pid_file'];
        if (!file_exists($pidFile)) {
            self::outputLog('It seems that Swoole is not running.', 'WARN');
            return;
        }

        $pid = file_get_contents($pidFile);
        if (self::kill($pid, 0)) {
            if (self::kill($pid, SIGTERM)) {
                // Make sure that master process quit
                $time = 1;
                $waitTime = 60;
                while (self::kill($pid, 0)) {
                    if ($time > $waitTime) {
                        self::outputLog(
                            "PID[{$pid}] cannot be stopped gracefully in {$waitTime}s, will be stopped forced right now.",
                            'WARN'
                        );
                        return;
                    }
                    self::outputLog("Waiting PID[{$pid}] to stop. [{$time}]");
                    sleep(1);
                    $time++;
                }
                if (file_exists($pidFile)) {
                    unlink($pidFile);
                }
                self::outputLog("PID[{$pid}] is stopped.");
            } else {
                self::outputLog("PID[{$pid}] is stopped failed.", 'ERROR');
            }
        } else {
            self::outputLog("PID[{$pid}] does not exist, or permission denied.", 'ERROR');
            if (file_exists($pidFile)) {
                unlink($pidFile);
            }
        }
    }

    public function restart()
    {
        $this->stop();
        $this->start();
    }

    public function reload()
    {
        $config = $this->getConfig();
        $pidFile = $config['svrConf']['swoole']['pid_file'];
        if (!file_exists($pidFile)) {
            self::outputLog('It seems that Swoole is not running.', 'ERROR');
            return;
        }

        $pid = file_get_contents($pidFile);
        if (!$pid || !self::kill($pid, 0)) {
            self::outputLog("PID[{$pid}] does not exist, or permission denied.", 'ERROR');
            return;
        }

        if (self::kill($pid, SIGUSR1)) {
            $now = date('Y-m-d H:i:s');
            self::outputLog("PID[{$pid}] is reloaded at {$now}.");
            return;
        } else {
            self::outputLog("PID[{$pid}] is reloaded failed.", 'ERROR');
            return;
        }
    }

    public static function runCommand($cmd, $input = null)
    {
        $fp = popen($cmd, 'w');
        if ($fp === false) {
            return false;
        }
        if ($input !== null) {
            fwrite($fp, $input);
        }
        pclose($fp);
        return true;
    }

    public static function kill($pid, $sig)
    {
        try {
            return Swoole\Process::kill($pid, $sig);
        } catch (\Exception $e) {
            return false;
        }
    }

    public static function outputLog($msg, $type = 'INFO')
    {
        echo sprintf('[%s] [%s] Swoole: %s', date('Y-m-d H:i:s'), $type, $msg), PHP_EOL;
    }
}